name: Create Daily Files

on:
  # JST 0時に実行 (UTC 15時)
  schedule:
    - cron: "0 15 * * *"
  # 手動でも実行できるようにする
  workflow_dispatch:

jobs:
  create_file:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Create daily file
        run: |
          # JSTの日付・年月・曜日を取得
          TODAY=$(TZ=Asia/Tokyo date "+%Y-%m-%d")
          YEAR=$(TZ=Asia/Tokyo date "+%Y")
          YEAR_MONTH=$(TZ=Asia/Tokyo date "+%Y-%m")
          FORMATTED_DATE=$(TZ=Asia/Tokyo date "+%Y/%m/%d")
          DOW=$(TZ=Asia/Tokyo date "+%a")

          # ディレクトリとファイルパスを作成
          DIR="${YEAR}/${YEAR_MONTH}"
          FILE_PATH="${DIR}/${TODAY}.md"

          # 存在チェック
          if [ -f "$FILE_PATH" ]; then
            echo "File already exists: $FILE_PATH"
            exit 0
          fi

          # ディレクトリ作成
          mkdir -p "$DIR"

          # ファイル作成 (1行目に日付と曜日を出力)
          echo "# ${FORMATTED_DATE} ${DOW}" > "$FILE_PATH"
          echo "Created: $FILE_PATH"

      - name: Commit and push
        run: |
          git config --local user.email "49823364+hirotoe0112@users.noreply.github.com"
          git config --local user.name "GitHub Actions[bot]"
          git add .
          git diff --staged --quiet || git commit -m "Create daily file: $(TZ=Asia/Tokyo date '+%Y-%m-%d')"
          git push
